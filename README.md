# mle-template-case-sprint2

Добро пожаловать в репозиторий-шаблон Практикума для проекта 2 спринта. Ваша цель — улучшить ключевые метрики модели для предсказания стоимости квартир Яндекс Недвижимости.

Полное описание проекта хранится в уроке «Проект. Улучшение baseline-модели» на учебной платформе.

Здесь укажите имя вашего бакета: s3-student-mle-20250329-2e5319257f

Для запуска проекта и установки библиотек необходимо выполнить следующие команды:

```bash
git clone https://github.com/Alexdemenev/mle-project-sprint-2-v001.git
cd mle-project-sprint-2-v001
pip install -r requirements.txt 
```

# Этап 1: Разворачивание MLflow и регистрация модели

1. Для запуска mlflow выполнить команды:

```bash
cd mlflow_server
bash run_mlflow_server.sh
```

2. Для просмотра результатов экспериментов перейти в MLflow UI по **http://127.0.0.1:5000/** в эксперимент **real_estate_model_alexdem** id_эксперимента: **7**

Код обучения и логирования модели в файле: mlflow_server/baseline_model.ipynb

# Этап 2: Исследовательский Анализ Данных (EDA)

RUN_ID с графиками экспериментов: *f2a68f9724184079a67d2f66291b8bf1*

### Выводы по результатам EDA

**Выводы по числовым признакам:**
1. Наибольшая стоимость квартир наблюдается в центральных значениях longitude и latitude. Если прогуглить, то видно, что это центр Москвы) В целом, данные фичи можно перевести в категориальные, взяв диапазон центральных значений и обозначив их как центр, а остальные использовать для идентификации окраины.

2. По годам постройки очень интересная ситуация: дома до 1960 года стоят дороже, чем современные, дома с 1960 по 2000, наоборот, дешевле. Это связано с тем, что очень старые дома считаются раритетом и стоят дорого, а современные дома, наоборот, модные и современные, поэтому снова стоят дорого, интервал с 60х по 00е - это постройки старого фонда.

3. Наибольшую линейную корреляцию с ценой можно увидеть у переменных, обозначающих размер квартиры: living_area, rooms, total_area. При этом, данные признаки сильно коррелируют друг с другом.

4. Чем современнее дом, тем в среднем больше этажей в доме, об этом свидетельствует корреляция build_year и total_floor.

**Выводы по категориальным признакам:**
1. В датасете не представлены квартиры-студии.

2. Наибольшую стоимость представляют квартиры с building_type_int 2 и 3.

3. В данных очень мало представлено квартир-апартаментов.

# Этап 3: Генерация признаков и обучение модели

На данном этапе были сгенерированы вручную следующие признаки: is_center, age_type.

С помощью AutoFeatRegressor были сгенерированы признаки: 1/floor, 1/total_area, 1/floors_total, 1/flats_coun. А также категориальные признаки, которые просто трансформировались с помощью onehot энкодинга. Среди категориальных признаков были выделены следующие: building_type_int, age_type.

Помимо генерации признаков также был произведен препроцессинг признаков:
* Для категориальных признаков - OneHotEncoder
* Для числовых: KBinsDiscretizer, QuantileTransformer, PolynomialFeatures, RobustScaler. Спойлер: признаки, полученные через полиномы, далее удалим, т.к. их много и они не помещаются в mlxtend.

Использование данных признаков привело к следующим улучшениям по сравнению с baseline:
1. MAE снизилось с 6957053.1 до 2358708.9
2. R2 вырос с -1.063 до 0.731

RUN_NAMEs, залогированные на данном этапе: **improved_model_real_estate**, **preprocessing** (его залогировал случайно, но он есть)

# Этап 4: Отбор признаков и обучение новой версии модели

Для отбора признаков использовались два подхода из библиотеки mlxtend: SequentialFeatureSelector методом forwar, и он же методом backward.

В результате были отобраны следующие признаки: 'cat__ohe__building_type_int_4.0', 'cat__ohe__building_type_int_1.0', 'cat__ohe__is_center_True', 'num__kbin__longitude', 'num__rb__ceiling_height', 'cat__ohe__has_elevator_True', 'num__rb__build_year', 'cat__ohe__age_type_retro', 'num__kbin__latitude', 'cat__ohe__is_apartment_True', 'num__q__total_area'. Эти признаки - результат объединения оптимальных признаков двух подходов.

RUN_NAMEs, залогированные на данном этапе: **feature_selection_model_real_estate**

# Этап 5: Подбор гиперпараметров и обучение новой версии модели

Для подбора гиперпараметров использовались два метода: Randomized Search и Baysean Search. Наилучший результат на предсказании теста получился с параметрами, подобранными через optuna.

RUN_NAMEs, залогированные на данном этапе:  
**randomized_search_model_real_estate**
**optuna_model_real_estate** - логирование каждого этапа через MLflowCallback
**bayesian_search_model_real_estate** - логирование модели с гиперпараметрами optuna
**best_model_real_estate** - наилучшая версия модели

# Выводы

В результате комбинации "ручных" наблюдений и инструментов работы с признаками и параметрами получилось обучить модель, показывающую максимальные значения метрик на тестовой выборке. При этом наиболее сильный прирост качества был достигнут на этапе препроцессинга и генерации фичей.
